<script lang="ts">
import type { Dye, HarmonyPattern } from '$lib/types';
import { selectPrimaryDye, regenerateSuggestions } from '$lib/stores/selection';
import { RefreshCw, BookOpenText } from 'lucide-svelte';

interface Props {
  selectedDye: Dye | null;
  suggestedDyes: [Dye, Dye] | null;
  pattern: HarmonyPattern;
}

const { selectedDye, suggestedDyes, pattern }: Props = $props();

function handleSuggestedDyeClick(dye: Dye): void {
  selectPrimaryDye(dye);
}

function handleRegenerate(): void {
  regenerateSuggestions();
}

// Vivid/Mutedモードかどうかを判定
const isRandomMode = $derived(pattern === 'vivid' || pattern === 'muted');
</script>

<div class="card bg-base-100 shadow-lg">
  <div class="card-body">
    {#if selectedDye && suggestedDyes}
      <div class="space-y-6">
        <!-- 3色のプレビュー -->
        <div class="grid grid-cols-3 gap-4">
          <!-- 基本カララント -->
          <div class="text-center">
            <div 
              class="w-full h-20 rounded-lg border-2 border-base-300 mb-2"
              style="background-color: {selectedDye.hex};"
            ></div>
            <h4 class="font-medium text-sm flex items-center justify-center gap-1">
              {#if selectedDye.lodestone}
                <a 
                  href={selectedDye.lodestone} 
                  class="hover:text-primary transition-colors flex items-center gap-1"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  <BookOpenText class="w-3 h-3" />
                  {selectedDye.name}
                </a>
              {:else}
                {selectedDye.name}
              {/if}
            </h4>
          </div>
          
          <!-- 提案カララント1 -->
          <div class="text-center">
            <button
              type="button"
              class="w-full h-20 rounded-lg border-2 border-base-300 mb-2 hover:border-primary transition-colors cursor-pointer"
              style="background-color: {suggestedDyes[0].hex};"
              onclick={() => handleSuggestedDyeClick(suggestedDyes[0])}
              title="この色を選択して新しい組み合わせを提案"
            ></button>
            <h4 class="font-medium text-sm flex items-center justify-center gap-1">
              {#if suggestedDyes[0].lodestone}
                <a 
                  href={suggestedDyes[0].lodestone} 
                  class="hover:text-primary transition-colors flex items-center gap-1"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  <BookOpenText class="w-3 h-3" />
                  {suggestedDyes[0].name}
                </a>
              {:else}
                {suggestedDyes[0].name}
              {/if}
            </h4>
          </div>
          
          <!-- 提案カララント2 -->
          <div class="text-center">
            <button
              type="button"
              class="w-full h-20 rounded-lg border-2 border-base-300 mb-2 hover:border-primary transition-colors cursor-pointer"
              style="background-color: {suggestedDyes[1].hex};"
              onclick={() => handleSuggestedDyeClick(suggestedDyes[1])}
              title="この色を選択して新しい組み合わせを提案"
            ></button>
            <h4 class="font-medium text-sm flex items-center justify-center gap-1">
              {#if suggestedDyes[1].lodestone}
                <a 
                  href={suggestedDyes[1].lodestone} 
                  class="hover:text-primary transition-colors flex items-center gap-1"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  <BookOpenText class="w-3 h-3" />
                  {suggestedDyes[1].name}
                </a>
              {:else}
                {suggestedDyes[1].name}
              {/if}
            </h4>
          </div>
        </div>
        
        <!-- 再生成ボタン（Vivid/Mutedモードの場合のみ） -->
        {#if isRandomMode}
          <div class="flex justify-center mt-4">
            <button
              type="button"
              class="btn btn-sm btn-ghost gap-2"
              onclick={handleRegenerate}
              title="新しい組み合わせを生成"
            >
              <RefreshCw class="w-4 h-4" />
              再生成
            </button>
          </div>
        {/if}
        
      </div>
    {:else}
      <div class="text-center py-8 text-base-content/50">
        カララントを選択すると<br>組み合わせプレビューが表示されます
      </div>
    {/if}
  </div>
</div>